generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Tenant {
  id                String             @id @default(cuid())
  name              String
  slug              String             @unique
  status            TenantStatus       @default(ACTIVE)
  logo              String?
  address           String?
  phone             String?
  email             String?
  website           String?
  timezone          String             @default("UTC")
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  actionControlLogs ActionControlLog[]
  appointments      Appointment[]
  auditLogs         AuditLog[]
  inventoryItems    InventoryItem[]
  invoices          Invoice[]
  notifications     Notification[]
  patients          Patient[]
  prescriptions     Prescription[]
  reviews           Review[]
  roles             Role[]
  services          Service[]
  supportTickets    SupportTicket[]
  users             User[]
  settings          TenantSettings?
  content           TenantContent?
  inventoryTransactions InventoryTransaction[]

  @@map("tenants")
}

model TenantSettings {
  id                String   @id @default(cuid())
  tenantId          String   @unique
  platformName      String?  // Custom clinic name override
  logoUrl           String?
  faviconUrl        String?
  primaryColor      String?
  secondaryColor    String?
  emailFooter       String?
  hoursOfOperation  Json?
  featureFlags      Json     @default("{}") // Online consultation, Pharmacy, etc.
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("tenant_settings")
}

model TenantContent {
  id               String   @id @default(cuid())
  tenantId         String   @unique
  aboutPage        String?  @db.Text
  mission          String?  @db.Text
  vision           String?  @db.Text
  testimonials     Json     @default("[]")
  faqs             Json     @default("[]")
  educationArticles Json    @default("[]")
  tenant           Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("tenant_content")
}

model User {
  id                 String             @id @default(cuid())
  tenantId           String?
  email              String             @unique
  passwordHash       String
  firstName          String
  lastName           String
  status             UserStatus         @default(ACTIVE)
  phone              String?
  avatar             String?
  specialty          String?
  licenseNo          String?
  bio                String?
  lastLoginAt        DateTime?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  roles              UserRoleMapping[]
  actionControlLogs  ActionControlLog[]
  doctorAppointments Appointment[]      @relation("DoctorAppointments")
  auditLogs          AuditLog[]
  invoicesCreated    Invoice[]          @relation("InvoiceCreator")
  prescriptions           Prescription[]     @relation("PrescribingDoctor")
  prescriptionsDispensed  Prescription[]     @relation("PrescriptionPharmacist")
  inventoryTransactions  InventoryTransaction[]
  supportMessages    SupportMessage[]
  userOverrides      UserOverride[]
  impersonations     ImpersonationLog[] @relation("AdminImpersonation")
  impersonatedBy     ImpersonationLog[] @relation("ImpersonatedUser")
  tenant             Tenant?            @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([email])
  @@map("users")
}

model UserRoleMapping {
  id         String    @id @default(cuid())
  userId     String
  roleId     String?   // Link to custom Tenant Role
  systemRole UserRole? // Link to hardcoded System Role enum
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  role       Role?     @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId, systemRole])
  @@map("user_roles_mapping")
}

model ImpersonationLog {
  id             String    @id @default(cuid())
  adminId        String
  impersonatedId String
  reason         String?
  startedAt      DateTime  @default(now())
  endedAt        DateTime?
  ipAddress      String?
  userAgent      String?
  admin          User      @relation("AdminImpersonation", fields: [adminId], references: [id])
  impersonated   User      @relation("ImpersonatedUser", fields: [impersonatedId], references: [id])

  @@map("impersonation_logs")
}

model Role {
  id              String           @id @default(cuid())
  tenantId        String
  name            String
  description     String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  rolePermissions RolePermission[]
  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userRoles       UserRoleMapping[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@map("roles")
}

model Permission {
  id              String           @id @default(cuid())
  name            String           @unique
  description     String?
  category        String?
  createdAt       DateTime         @default(now())
  rolePermissions RolePermission[]
  userOverrides   UserOverride[]

  @@map("permissions")
}

model RolePermission {
  id           String     @id @default(cuid())
  roleId       String
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

model UserOverride {
  id           String     @id @default(cuid())
  userId       String
  permissionId String
  granted      Boolean    @default(true)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, permissionId])
  @@map("user_overrides")
}

model Patient {
  id                String          @id @default(cuid())
  tenantId          String
  phone             String
  firstName         String
  lastName          String
  email             String?
  dateOfBirth       DateTime?
  gender            String?
  address           String?
  bloodType         String?
  allergies         String?
  medicalNotes      String?
  insuranceProvider String?
  insurancePolicyNo String?
  avatar            String?
  isVerified        Boolean         @default(false)
  lastVisitAt       DateTime?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  appointments      Appointment[]
  invoices          Invoice[]
  tenant            Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  prescriptions     Prescription[]
  reviews           Review[]
  supportTickets    SupportTicket[]

  @@unique([tenantId, phone])
  @@index([tenantId])
  @@map("patients")
}

model Service {
  id                    String                  @id @default(cuid())
  tenantId              String
  name                  String
  description           String?
  category              ServiceCategory
  duration              Int
  price                 Float
  isActive              Boolean                 @default(true)
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  appointments          Appointment[]
  procedureInventoryMap ProcedureInventoryMap[]
  tenant                Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("services")
}

model Appointment {
  id                 String                  @id @default(cuid())
  tenantId           String
  patientId          String
  doctorId           String
  serviceId          String
  type               AppointmentType         @default(IN_PERSON)
  status             AppointmentStatus       @default(SCHEDULED)
  dateTime           DateTime
  endTime            DateTime
  bufferMinutes      Int                     @default(15)
  notes              String?
  cancellationReason String?
  videoSessionId     String?
  checkedInAt        DateTime?
  completedAt        DateTime?
  createdAt          DateTime                @default(now())
  updatedAt          DateTime                @updatedAt
  transitions        AppointmentTransition[]
  doctor             User                    @relation("DoctorAppointments", fields: [doctorId], references: [id])
  patient            Patient                 @relation(fields: [patientId], references: [id])
  service            Service                 @relation(fields: [serviceId], references: [id])
  tenant             Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  invoice            Invoice?
  prescription       Prescription?

  @@index([tenantId])
  @@index([doctorId, dateTime])
  @@index([patientId])
  @@map("appointments")
}

model AppointmentTransition {
  id            String            @id @default(cuid())
  appointmentId String
  fromStatus    AppointmentStatus
  toStatus      AppointmentStatus
  triggeredBy   String
  reason        String?
  timestamp     DateTime          @default(now())
  appointment   Appointment       @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  @@index([appointmentId])
  @@map("appointment_transitions")
}

model InventoryItem {
  id                    String                  @id @default(cuid())
  tenantId              String
  name                  String
  sku                   String?
  quantity              Int                     @default(0)
  threshold             Int                     @default(10)
  unit                  String                  @default("units")
  cost                  Float?
  supplier              String?
  expiresAt             DateTime?
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  tenant                Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  procedureInventoryMap ProcedureInventoryMap[]
  transactions          InventoryTransaction[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@map("inventory_items")
}

model ProcedureInventoryMap {
  id              String        @id @default(cuid())
  serviceId       String
  inventoryItemId String
  quantityUsed    Float         @default(1)
  inventoryItem   InventoryItem @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)
  service         Service       @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([serviceId, inventoryItemId])
  @@map("procedure_inventory_map")
}

model Invoice {
  id            String      @id @default(cuid())
  tenantId      String
  patientId     String
  appointmentId String      @unique
  createdById   String
  amount        Float
  tax           Float       @default(0)
  discount      Float       @default(0)
  totalAmount   Float
  status        String      @default("UNPAID")
  paidAt        DateTime?
  notes         String?
  items         Json        @default("[]")
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  appointment   Appointment @relation(fields: [appointmentId], references: [id])
  createdBy     User        @relation("InvoiceCreator", fields: [createdById], references: [id])
  patient       Patient     @relation(fields: [patientId], references: [id])
  tenant        Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([patientId])
  @@map("invoices")
}

model Prescription {
  id            String             @id @default(cuid())
  tenantId      String
  patientId     String
  appointmentId String?            @unique
  doctorId      String
  status        PrescriptionStatus @default(PENDING)
  medications   Json               @default("[]")
  instructions  String?
  issuedAt      DateTime           @default(now())
  validUntil    DateTime?
  dispensedAt   DateTime?
  dispensedById String?
  version       Int                @default(1)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  appointment   Appointment?       @relation(fields: [appointmentId], references: [id])
  doctor        User               @relation("PrescribingDoctor", fields: [doctorId], references: [id])
  dispensedBy   User?              @relation("PrescriptionPharmacist", fields: [dispensedById], references: [id])
  patient       Patient            @relation(fields: [patientId], references: [id])
  tenant        Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([patientId])
  @@map("prescriptions")
}

model SupportTicket {
  id          String           @id @default(cuid())
  tenantId    String
  patientId   String
  issueType   String
  severity    TicketSeverity   @default(MEDIUM)
  subject     String
  description String
  status      TicketStatus     @default(OPEN)
  attachments Json             @default("[]")
  assignedTo  String?
  resolvedAt  DateTime?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  messages    SupportMessage[]
  patient     Patient          @relation(fields: [patientId], references: [id])
  tenant      Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([severity])
  @@map("support_tickets")
}

model SupportMessage {
  id          String        @id @default(cuid())
  ticketId    String
  senderId    String
  senderRole  String
  content     String
  attachments Json          @default("[]")
  isInternal  Boolean       @default(false)
  timestamp   DateTime      @default(now())
  sender      User          @relation(fields: [senderId], references: [id])
  ticket      SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@map("support_messages")
}

model Notification {
  id          String              @id @default(cuid())
  tenantId    String
  recipientId String
  channel     NotificationChannel
  type        String
  title       String
  content     String
  metadata    Json                @default("{}")
  status      NotificationStatus  @default(PENDING)
  sentAt      DateTime?
  deliveredAt DateTime?
  failedAt    DateTime?
  failReason  String?
  createdAt   DateTime            @default(now())
  tenant      Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([recipientId])
  @@index([status])
  @@map("notifications")
}

model AuditLog {
  id        String   @id @default(cuid())
  tenantId  String?
  userId    String
  action    String
  entity    String
  entityId  String
  oldValue  Json?
  newValue  Json?
  ipAddress String?
  userAgent String?
  timestamp DateTime @default(now())
  tenant    Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])

  @@index([tenantId])
  @@index([userId])
  @@index([entity, entityId])
  @@index([timestamp])
  @@map("audit_logs")
}

model ActionControlLog {
  id        String         @id @default(cuid())
  tenantId  String
  userId    String
  action    OverrideAction
  entity    String
  entityId  String
  reason    String
  oldValue  Json?
  newValue  Json?
  metadata  Json           @default("{}")
  timestamp DateTime       @default(now())
  tenant    Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user      User           @relation(fields: [userId], references: [id])

  @@index([tenantId])
  @@index([action])
  @@index([timestamp])
  @@map("action_control_logs")
}

model SystemConfig {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  updatedAt DateTime @updatedAt
  updatedBy String?

  @@map("system_config")
}

model BackupLog {
  id           String       @id @default(cuid())
  type         String       @default("FULL")
  tenantId     String?
  status       BackupStatus @default(PENDING)
  filePath     String?
  fileSize     BigInt?
  triggeredBy  String
  startedAt    DateTime     @default(now())
  completedAt  DateTime?
  errorMessage String?

  @@index([status])
  @@map("backup_logs")
}

model Review {
  id         String   @id @default(cuid())
  tenantId   String
  patientId  String?
  authorName String
  rating     Int      @default(5)
  comment    String
  isApproved Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  patient    Patient? @relation(fields: [patientId], references: [id])
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([isApproved])
  @@map("reviews")
}

model PlatformSettings {
  id                String   @id @default("global-settings")
  platformName      String   @default("Nexus Dental")
  logoUrl           String?
  faviconUrl        String?
  primaryColor      String   @default("#008080")
  secondaryColor    String   @default("#FFD700")
  supportEmail      String?
  supportPhone      String?
  emailFooter       String?
  maintenanceMode   Boolean  @default(false)
  allowRegistration Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("platform_settings")
}

enum TenantStatus {
  ACTIVE
  FROZEN
  MAINTENANCE
  SUSPENDED
}

enum UserRole {
  SYSTEM_OWNER
  ADMIN
  DOCTOR
  NURSE
  RECEPTIONIST
  INVENTORY_MANAGER
  BILLING_STAFF
  CLINIC_OWNER
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum PrescriptionStatus {
  PENDING
  FILLED
  CANCELLED
  EXPIRED
}

enum AppointmentStatus {
  SCHEDULED
  CHECKED_IN
  IN_IMAGING
  IN_CHAIR
  COMPLETED
  CHECKOUT
  CANCELLED
  NO_SHOW
}

enum AppointmentType {
  IN_PERSON
  VIRTUAL
}

enum ServiceCategory {
  GENERAL
  COSMETIC
  ORTHODONTICS
  RESTORATIVE
  PEDIATRIC
  EMERGENCY
  CONSULTATION
}

enum TicketSeverity {
  LOW
  MEDIUM
  HIGH
  EMERGENCY
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_ON_PATIENT
  ESCALATED
  RESOLVED
  CLOSED
}

enum NotificationChannel {
  WHATSAPP
  SMS
  EMAIL
  PUSH
}

enum NotificationStatus {
  PENDING
  QUEUED
  SENT
  DELIVERED
  FAILED
}

enum OverrideAction {
  INVENTORY_ADJUST
  APPOINTMENT_STATUS_CHANGE
  REMINDER_DISABLE
  ESCALATION_DOWNGRADE
  BUFFER_REMOVAL
  PERMISSION_OVERRIDE
  SCHEDULE_OVERRIDE
}

enum SystemStatus {
  OPERATIONAL
  MAINTENANCE
  DEGRADED
}

enum BackupStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

enum InventoryTransactionType {
  RESTOCK
  DISPENSED
  PROCEDURE_USE
  ADJUSTMENT
  EXPIRED
  REMOVED
}

model InventoryTransaction {
  id              String                   @id @default(cuid())
  tenantId        String
  inventoryItemId String
  userId          String
  type            InventoryTransactionType
  quantity        Float
  notes           String?
  timestamp       DateTime                 @default(now())
  inventoryItem   InventoryItem            @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)
  user            User                     @relation(fields: [userId], references: [id])
  tenant          Tenant                   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([inventoryItemId])
  @@map("inventory_transactions")
}
